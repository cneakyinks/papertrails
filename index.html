<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Paper Trail - Happy Valentines, Dear</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #fdf6f0;
            font-family: 'EB Garamond', serif;
        }

        #experience-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #page-header {
            position: absolute;
            top: 30px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        #page-header h1 {
            font-weight: 400;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: #b5a49b;
            margin: 0;
        }

        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 5;
            transition: opacity 1s ease;
        }

        #input-zone {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            padding: 40px;
            border-radius: 20px;
            width: 85%;
            max-width: 450px;
            pointer-events: auto;
            box-shadow: 0 20px 50px rgba(220, 180, 180, 0.15);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .field-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 2px;
            color: #b5a49b;
            margin-bottom: 5px;
        }

        input, textarea {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid #f0e1e1;
            font-family: 'Dancing Script', cursive;
            font-size: 1.3rem;
            color: #8e8e8e;
            outline: none;
            padding: 5px 0;
            resize: none;
        }

        #controls {
            margin-top: 30px;
            display: flex;
            gap: 12px;
        }

        button {
            flex: 1;
            background: #ffffff;
            border: 1px solid #f0e1e1;
            padding: 12px 10px;
            font-family: 'EB Garamond', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #5a4b4b;
            border-radius: 4px;
        }

        button:disabled { opacity: 0.5; cursor: wait; }
        #monologise-btn { background: #ffeef2; border-color: #ffd1dc; }

        #final-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #roses-img {
            width: 350px;
            max-width: 80vw;
            height: auto;
            opacity: 0;
            transform: scale(0.1);
            margin-bottom: 30px;
        }

        #final-text {
            font-weight: 400;
            font-style: italic;
            color: #ffffff;
            opacity: 0;
            transform: translateY(20px);
            text-align: center;
        }

        /* PIN Access Modal */
        #api-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #error-toast {
            position: fixed;
            bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #ff6b6b; color: white; padding: 10px 20px;
            border-radius: 5px; font-size: 0.8rem; display: none; z-index: 2000;
        }
    </style>
</head>
<body>

    <div id="page-header"><h1>Paper Trail</h1></div>
    <div id="experience-container"></div>
    
    <div id="ui-overlay">
        <div id="input-zone">
            <div class="field-group">
                <label>To</label>
                <input type="text" id="to-field" value="You">
            </div>
            <div class="field-group">
                <label>The Sentiment</label>
                <textarea id="note-body" rows="3">I have something to say.</textarea>
            </div>
            <div class="field-group">
                <label>From</label>
                <input type="text" id="from-field" value="Me">
            </div>
            <div id="controls">
                <button id="monologise-btn" onclick="checkAccess()">Monolog-ise</button>
                <button id="bin-btn" onclick="startBinning()">Bin It</button>
                <button id="send-btn" onclick="sendToStars()">Archive</button>
            </div>
        </div>
    </div>

    <!-- PIN Access Modal -->
    <div id="api-modal">
        <div class="modal-content">
            <h2 style="margin-top:0; font-weight: 400; color: #b5a49b;">Access AI</h2>
            <p style="font-size: 0.85rem; color: #888; margin-bottom: 20px;">Enter the shared PIN to unlock the Monolog-ise feature.</p>
            <input type="password" id="pin-input" maxlength="4" placeholder="••••" style="font-family: sans-serif; text-align: center; font-size: 2rem; letter-spacing: 10px; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px;">
            <div style="display:flex; gap:10px;">
                <button onclick="validatePin()">Unlock</button>
                <button style="background:#eee" onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="final-screen">
        <img id="roses-img" src="image_faaef5.jpg" onerror="this.src='image_fa58fc.png';" alt="Roses">
        <h1 id="final-text">Happy Valentines, Dear.</h1>
    </div>

    <div id="error-toast"></div>

    <script>
        /**
         * SECURITY CONFIGURATION
         * 1. Open your browser console (F12)
         * 2. Run this: console.log(crypt("YOUR_ACTUAL_API_KEY", "1402"))
         * 3. Copy the long string it produces and paste it into OBFUSCATED_KEY below.
         */
        const OBFUSCATED_KEY = ""; // Paste your crypted string here
        const PIN_KEY = "1402";

        function crypt(text, key) {
            return text.split('').map((char, i) => 
                String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))
            ).map(c => btoa(c)).join('.');
        }

        function decrypt(cipher, key) {
            try {
                return cipher.split('.').map(part => atob(part)).map((char, i) => 
                    String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))
                ).join('');
            } catch(e) { return null; }
        }

        function checkAccess() {
            const unlocked = sessionStorage.getItem('AI_UNLOCKED');
            if (unlocked === 'true') {
                const key = decrypt(OBFUSCATED_KEY, PIN_KEY);
                monologise(key);
            } else {
                document.getElementById('api-modal').style.display = 'flex';
                document.getElementById('pin-input').focus();
            }
        }

        function validatePin() {
            const pin = document.getElementById('pin-input').value;
            if (pin === PIN_KEY) {
                sessionStorage.setItem('AI_UNLOCKED', 'true');
                hideModal();
                const key = decrypt(OBFUSCATED_KEY, PIN_KEY);
                monologise(key);
            } else {
                showError("Incorrect PIN.");
                document.getElementById('pin-input').value = "";
            }
        }

        function hideModal() {
            document.getElementById('api-modal').style.display = 'none';
        }

        // Scene Logic
        let scene, camera, renderer, heart, paperMaterial, texture;
        const container = document.getElementById('experience-container');
        let canvas, ctx;
        let isBinning = false;
        let tapCount = 0;
        const maxTaps = 20;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xfdf6f0);
            camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 6;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));

            createHeartPaper();
            setupCanvasTexture();
            animate();
        }

        function createHeartPaper() {
            const x = 0, y = 0;
            const heartShape = new THREE.Shape();
            heartShape.moveTo(x + 0.25, y + 0.25);
            heartShape.bezierCurveTo(x + 0.25, y + 0.25, x + 0.2, y, x, y);
            heartShape.bezierCurveTo(x - 0.3, y, x - 0.3, y + 0.35, x - 0.3, y + 0.35);
            heartShape.bezierCurveTo(x - 0.3, y + 0.55, x - 0.1, y + 0.77, x + 0.25, y + 0.95);
            heartShape.bezierCurveTo(x + 0.6, y + 0.77, x + 0.8, y + 0.55, x + 0.8, y + 0.35);
            heartShape.bezierCurveTo(x + 0.8, y + 0.35, x + 0.8, y, x + 0.5, y);
            heartShape.bezierCurveTo(x + 0.35, y, x + 0.25, y + 0.25, x + 0.25, y + 0.25);

            const geometry = new THREE.ShapeGeometry(heartShape, 64);
            geometry.center();
            geometry.scale(4, 4, 4);
            geometry.rotateZ(Math.PI);

            paperMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    uMap: { value: null },
                    uCrunch: { value: 0.0 },
                    uTime: { value: 0.0 },
                    uFade: { value: 0.0 }
                },
                vertexShader: `
                    varying vec2 vUv;
                    uniform float uCrunch;
                    uniform float uTime;
                    void main() {
                        vUv = uv;
                        vec3 pos = position;
                        if(uCrunch > 0.0) {
                            pos.xyz *= (1.0 - uCrunch * 0.5);
                            pos.z += sin(pos.x * 10.0 + uTime) * uCrunch;
                        }
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }
                `,
                fragmentShader: `
                    varying vec2 vUv;
                    uniform sampler2D uMap;
                    uniform float uCrunch;
                    uniform float uFade;
                    void main() {
                        vec4 tex = texture2D(uMap, vUv);
                        gl_FragColor = vec4(tex.rgb * (1.0 - uFade), 1.0);
                    }
                `,
                side: THREE.DoubleSide
            });

            heart = new THREE.Mesh(geometry, paperMaterial);
            scene.add(heart);
        }

        function setupCanvasTexture() {
            canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 1024;
            ctx = canvas.getContext('2d');
            texture = new THREE.CanvasTexture(canvas);
            paperMaterial.uniforms.uMap.value = texture;
            updatePaperTexture();
        }

        function updatePaperTexture() {
            const to = document.getElementById('to-field').value;
            const body = document.getElementById('note-body').value;
            const from = document.getElementById('from-field').value;
            ctx.fillStyle = '#fff0f3';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#ffd1dc'; ctx.lineWidth = 3;
            for(let i=0; i<canvas.height; i+=45) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(Math.PI); ctx.translate(-canvas.width/2, -canvas.height/2);
            ctx.fillStyle = '#7a7a7a'; ctx.textAlign = 'center';
            ctx.font = '52px "Dancing Script"'; ctx.fillText(`To: ${to}`, 512, 380);
            ctx.font = '46px "Dancing Script"'; ctx.fillText(body, 512, 550, 800);
            ctx.font = '42px "Dancing Script"'; ctx.fillText(`— ${from}`, 512, 700);
            ctx.restore();
            texture.needsUpdate = true;
        }

        async function monologise(key) {
            if (!key) { showError("Key Decryption Failed."); return; }
            const btn = document.getElementById('monologise-btn');
            btn.disabled = true;
            const input = document.getElementById('note-body').value;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Rephrase this sentiment into a short, poetic, single-line monolog: "${input}"` }] }]
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    document.getElementById('note-body').value = text.trim();
                    updatePaperTexture();
                }
            } catch (err) {
                showError("AI Error. Check your key/limit.");
            } finally {
                btn.disabled = false;
            }
        }

        function startBinning() {
            isBinning = true; tapCount = 0;
            document.getElementById('ui-overlay').style.opacity = '0';
            window.addEventListener('mousedown', handleTap);
        }

        function handleTap() {
            if(!isBinning) return;
            tapCount++;
            gsap.to(paperMaterial.uniforms.uCrunch, { value: tapCount/maxTaps, duration: 0.1 });
            if(tapCount >= maxTaps) finishExperience();
        }

        function sendToStars() {
            document.getElementById('ui-overlay').style.opacity = '0';
            const tl = gsap.timeline({ onComplete: showFinalScreen });
            tl.to(heart.position, { z: -100, y: 100, duration: 3, ease: "power2.in" });
            tl.to(paperMaterial.uniforms.uFade, { value: 1, duration: 2 }, 0);
            tl.to(scene.background, { r:0, g:0, b:0, duration: 3, onUpdate:()=>renderer.setClearColor(scene.background) }, 0);
        }

        function finishExperience() {
            isBinning = false;
            const tl = gsap.timeline({ onComplete: showFinalScreen });
            tl.to(heart.scale, { x:0, y:0, z:0, duration: 1.5, ease: "power2.in" });
            tl.to(scene.background, { r:0, g:0, b:0, duration: 1.5, onUpdate:()=>renderer.setClearColor(scene.background) }, 0);
        }

        function showFinalScreen() {
            document.getElementById('final-screen').style.display = 'flex';
            const tl = gsap.timeline();
            tl.to("#roses-img", { opacity: 1, scale: 1, duration: 4, ease: "power2.out" });
            tl.to("#final-text", { opacity: 1, y: 0, duration: 2 }, "-=2");
        }

        function showError(m) {
            const t = document.getElementById('error-toast');
            t.innerText = m; t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 3000);
        }

        function animate(t) {
            requestAnimationFrame(animate);
            if(paperMaterial) paperMaterial.uniforms.uTime.value = t * 0.001;
            if(!isBinning && heart) heart.position.y = Math.sin(t * 0.001) * 0.1;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
